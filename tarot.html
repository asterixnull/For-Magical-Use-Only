<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slab City Vortex Tarot</title>
    <link href="https://fonts.googleapis.com/css2?family=Unica+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <nav>
        <a href="index.html" title="Home"><i class="fas fa-home"></i></a>
        <a href="aboutthemagic.html" title="About"><i class="fas fa-info-circle"></i></a>
        <a href="gallery.html" title="Gallery"><i class="fas fa-images"></i></a>
        <a href="marketplace.html" title="Shop"><i class="fas fa-shopping-cart"></i></a>
        <a href="tours.html" title="Tours"><i class="fas fa-map-marked-alt"></i></a>
        <a href="support.html" title="Support"><i class="fas fa-heart"></i></a>
        <a href="draw.html" title="Draw"><i class="fas fa-pencil-alt"></i></a>
        <a href="tarot.html" title="Tarot"><i class="fas fa-book-open"></i></a>
        <a href="contact.html" title="Contact"><i class="fas fa-envelope"></i></a>
    </nav>
    <div id="tarot-container">
        <button id="draw-button">Draw the Vortex</button>
        <!-- Tarot cards will be dynamically inserted here -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tarotContainer = document.getElementById('tarot-container');
            let allCards = [];
            let assets = [];

            const positions = [
                { top: '50%', left: '50%', transform: 'rotate(0deg) scale(1)' },
                { top: '40%', left: '60%', transform: 'rotate(45deg) scale(0.9)' },
                { top: '30%', left: '70%', transform: 'rotate(90deg) scale(0.8)' },
                { top: '40%', left: '40%', transform: 'rotate(135deg) scale(0.9)' },
                { top: '60%', left: '30%', transform: 'rotate(180deg) scale(0.8)' },
                { top: '70%', left: '40%', transform: 'rotate(225deg) scale(0.9)' },
                { top: '60%', left: '60%', transform: 'rotate(270deg) scale(0.8)' }
            ];

            // Fetch all tarot cards from the secure API on page load
            fetch('/api/contentful?content_type=RGC6GL7ZkM9GmI3xm2aFz')
                .then(response => response.json())
                .then(data => {
                    allCards = data.items;
                    assets = data.includes.Asset;
                })
                .catch(console.error);

            function attachDrawListener() {
                const drawButton = document.getElementById('draw-button');
                if (drawButton) {
                    drawButton.addEventListener('click', drawCards);
                }
            }

            function drawCards() {
                // Clear previous draw but keep the button
                tarotContainer.innerHTML = '<button id="draw-button">Draw the Vortex</button>';
                attachDrawListener();

                if (allCards.length === 0) {
                    alert("The cards are still being shuffled. Please wait a moment and try again.");
                    return;
                }

                const drawnCards = [];
                while (drawnCards.length < 7 && drawnCards.length < allCards.length) {
                    const card = allCards[Math.floor(Math.random() * allCards.length)];
                    if (!drawnCards.find(c => c.sys.id === card.sys.id)) {
                        drawnCards.push(card);
                    }
                }

                drawnCards.forEach((cardData, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.classList.add('card');

                    const cardName = document.createElement('h2');
                    cardName.textContent = cardData.fields.cardName;
                    cardElement.appendChild(cardName);

                    const cardImage = document.createElement('img');
                    const imageAsset = assets.find(asset => asset.sys.id === cardData.fields.cardImage.sys.id);
                    if (imageAsset) {
                        cardImage.src = 'https:' + imageAsset.fields.file.url;
                        cardImage.alt = imageAsset.fields.title;
                        cardElement.appendChild(cardImage);
                    }

                    const cardDescription = document.createElement('p');
                    cardDescription.textContent = cardData.fields.cardDescription;
                    cardElement.appendChild(cardDescription);

                    cardElement.style.top = positions[index].top;
                    cardElement.style.left = positions[index].left;
                    cardElement.style.transform = positions[index].transform;

                    tarotContainer.appendChild(cardElement);

                    // Psychedelic orbit animation
                    let angle = 0;
                    const orbit = setInterval(() => {
                        angle += 2;
                        cardElement.style.transform = `${positions[index].transform} translate(${Math.sin(angle * Math.PI / 180) * 50}px, ${Math.cos(angle * Math.PI / 180) * 50}px)`;
                        if (angle >= 360) clearInterval(orbit);
                    }, 50);
                });
            }

            attachDrawListener();

            // Full Moon Distortion
            window.addEventListener('load', () => {
                const now = new Date();
            const day = now.getDate();
            const month = now.getMonth() + 1;
            const isFullMoon = [17].includes(day) && month === 10; // Oct 17, 2025â€”adjust for real dates
            if (isFullMoon) {
                document.body.style.transform = 'rotate(5deg) scale(1.1)';
                document.body.style.filter = 'hue-rotate(90deg)';
                setInterval(() => document.body.style.filter = `hue-rotate(${Math.random() * 360}deg)`, 2000);
            }

            // Third Tuesday Flip
            const isThirdTuesday = (day >= 15 && day <= 21) && (new Date(now.getFullYear(), month - 1, day).getDay() === 2);
            if (isThirdTuesday) document.body.style.transform = 'rotate(180deg)';
        });
        });
    </script>
</body>
</html>
