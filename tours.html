<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tours - FOR Magical Use Only</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <header id="page-header">
        <h1 id="page-title">Tours</h1>
    </header>
    <section class="page-description" id="page-description">
        <!-- Page description will be dynamically inserted here -->
    </section>
    <nav>
        <a href="index.html" title="Home"><i class="fas fa-home"></i></a>
        <a href="aboutthemagic.html" title="About"><i class="fas fa-info-circle"></i></a>
        <a href="gallery.html" title="Gallery"><i class="fas fa-images"></i></a>
        <a href="marketplace.html" title="Shop"><i class="fas fa-shopping-cart"></i></a>
        <a href="tours.html" title="Tours"><i class="fas fa-map-marked-alt"></i></a>
        <a href="support.html" title="Support"><i class="fas fa-heart"></i></a>
        <a href="draw.html" title="Draw"><i class="fas fa-pencil-alt"></i></a>
        <a href="tarot.html" title="Tarot"><i class="fas fa-book-open"></i></a>
        <a href="contact.html" title="Contact"><i class="fas fa-envelope"></i></a>
    </nav>
    <section class="tours-section" id="tours-container">
        <!-- Tour packages will be dynamically inserted here -->
    </section>
    <footer>
        <p>&copy; 2025 FOR Magical Use Only. Crafted in Slab Cityâ€™s dust.</p>
    </footer>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const pageHeader = document.getElementById('page-header');
            const pageTitle = document.getElementById('page-title');
            const pageDescription = document.getElementById('page-description');

            // Fetch the 'Page' content for the Tours page
            try {
                const pageResponse = await fetch('/api/contentful?content_type=1XN3CX7ObBGrENgewbJlIG');
                const pageData = await pageResponse.json();

                const page = pageData.items.find(p => p.fields.pageTitle === 'Tours');
                if (page) {
                    pageTitle.textContent = page.fields.pageTitle;
                    pageDescription.textContent = page.fields.pageDescription;

                    const imageAsset = pageData.includes.Asset.find(asset => asset.sys.id === page.fields.headerBackgroundImage.sys.id);
                    if (imageAsset) {
                         pageHeader.style.backgroundImage = `url(https:${imageAsset.fields.file.url})`;
                    }
                }
            } catch (error) {
                console.error('Failed to load page data:', error);
            }

            const stripe = Stripe('pk_live_51P3Z5yRxKIpEa9z2e3hVj0oMOq40S3nK1gWqWjOr3a2wEV2kRr5e5PA3mjaqYkFp2DkS44tYgNn581ywhaCAc6ca00b0TFEuGq');
            const toursContainer = document.getElementById('tours-container');

            // Now, fetch the tour packages
            try {
                const toursResponse = await fetch('/api/contentful?content_type=70oPrCNwUtqI05YuxYLW9D');
                const toursData = await toursResponse.json();

                toursData.items.forEach(item => {
                    const tourPackage = document.createElement('div');
                    tourPackage.classList.add('tour-package');

                    const tourName = document.createElement('h2');
                    tourName.textContent = item.fields.tourName;
                    tourPackage.appendChild(tourName);

                    const tourDescription = document.createElement('p');
                    tourDescription.textContent = item.fields.tourDescription;
                    tourPackage.appendChild(tourDescription);

                    const tourImage = document.createElement('img');
                    const imageAsset = toursData.includes.Asset.find(asset => asset.sys.id === item.fields.tourImage.sys.id);
                    if (imageAsset) {
                        tourImage.src = 'https:' + imageAsset.fields.file.url;
                        tourImage.alt = imageAsset.fields.title;
                        tourPackage.appendChild(tourImage);
                    }

                    const price = document.createElement('div');
                    price.classList.add('price');
                    price.textContent = `\$${item.fields.price}`;
                    tourPackage.appendChild(price);

                    const bookButton = document.createElement('button');
                    bookButton.classList.add('buy-button');
                    bookButton.textContent = 'Book Now';
                    bookButton.addEventListener('click', () => {
                        stripe.redirectToCheckout({
                            lineItems: [{
                                price: item.fields.stripePriceId,
                                quantity: 1
                            }],
                            mode: 'payment',
                            successUrl: window.location.origin + '/tour-success.html',
                            cancelUrl: window.location.origin + '/tour-cancel.html',
                        })
                        .then(function (result) {
                            if (result.error) {
                                alert(result.error.message);
                            }
                        });
                    });
                    tourPackage.appendChild(bookButton);

                    toursContainer.appendChild(tourPackage);
                });
            } catch (error) {
                console.error('Failed to load tour data:', error);
            }
        });
    </script>
</body>
</html>
